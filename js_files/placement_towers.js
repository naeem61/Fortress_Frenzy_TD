tiledMapData_map1 = [
  2927, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 2927, 0, 0, 0, 0, 0, 2927, 0, 2927, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  2927, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927,
  0, 0, 2927, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 0, 0, 0, 0, 2927, 0,
  0, 2927, 0, 0, 0, 0, 2927, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 0, 2927,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 0, 2927, 0,
  0, 0, 0, 2927, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 0, 2927, 0, 0, 0, 0,
  2927, 0, 2927, 0, 2927, 0, 0, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 0, 2927, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 2927, 0,
  2927, 0, 2927, 0, 0, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 2927, 0,
  2927, 0, 0, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 2927, 0, 2927, 0, 0,
  0, 0, 2927, 0, 0, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 0, 0,
  0, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 2927, 0, 2927, 0, 0, 0, 0, 2927,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 2927, 0, 2927, 0, 2927, 0, 0, 0, 0, 2927, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 2927, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 2927, 0, 2927, 0, 0, 0, 0, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 2927, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 0,
  2927, 0, 0, 0, 0, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 2927,
  0, 2927, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 0, 2927, 0, 0,
  0, 0, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 2927, 0,
  0, 2927, 0, 0, 0, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 2927, 0, 0, 0, 0,
  0, 0, 2927, 0, 0, 0, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 2927, 0, 0,
  2927, 0, 0, 0, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 2927, 0, 0, 0, 0, 0,
  0, 2927, 0, 0, 0, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 2927, 0, 0, 2927,
  0, 0, 0, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 2927, 0, 2927, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 2927, 0, 2927, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 2927, 0, 2927, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  2927, 0, 2927, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927,
  0, 2927, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 0, 2927, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 0, 0, 2927, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 0, 2927, 0, 0, 0, 0, 0, 0, 0, 2927, 0,
  2927, 0, 0, 0, 0, 0, 0, 2927, 0, 2927, 0, 0, 2927, 0, 0, 2927, 0, 2927, 0,
  2927, 0, 0, 0, 0, 2927, 0, 2927, 0, 2927, 0, 2927, 0, 0, 0, 0, 0,
];

tiledMapData_map2 = [
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 2927, 0, 0, 0, 0,
  0, 0, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  0, 0, 0, 0, 0, 0, 0, 2927, 2927, 0, 0, 0, 0, 0, 0, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 0, 0, 0, 0, 0, 0, 0, 2927, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 0, 0, 0, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  0, 0, 0, 0, 0, 0, 2927, 0, 0, 0, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 0, 0, 0, 0, 0, 0,
  2927, 0, 0, 0, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 0, 0, 0, 0, 0, 0, 2927, 0, 0, 0,
  2927, 2927, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 2927, 0, 0, 0, 2927, 2927, 0, 0, 0,
  2927, 2927, 0, 0, 2927, 2927, 0, 0, 0, 0, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 0, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 2927, 0, 0, 0,
  2927, 2927, 0, 0, 0, 2927, 2927, 0, 0, 2927, 2927, 0, 0, 0, 0, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 0, 0, 0, 2927, 0, 0, 0,
  0, 0, 0, 2927, 0, 0, 0, 2927, 2927, 0, 0, 0, 2927, 2927, 2927, 2927, 2927,
  2927, 0, 0, 0, 0, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 0, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 2927, 0, 0, 0, 2927, 2927, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 2927, 0, 0, 0,
  2927, 0, 0, 0, 0, 0, 0, 2927, 0, 0, 0, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 0, 0, 2927,
  2927, 0, 0, 0, 2927, 2927, 0, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 2927, 0, 0, 0,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 0, 0, 2927, 2927, 0, 0, 0, 2927, 2927, 0, 0, 0, 2927,
  0, 0, 0, 0, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 2927, 0, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 0, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  0, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 0, 0, 0, 2927, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 0, 0, 0, 0, 0, 0, 0, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 0, 0, 0, 0, 0, 0,
  2927, 2927, 0, 0, 0, 0, 0, 0, 0, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 0, 0, 0, 0, 0, 0, 2927, 2927, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927, 2927,
  2927, 2927, 2927, 2927, 2927, 2927,
];

const mapWidth = 40;
const mapHeight = 24;
let map2DArray = [];
let towers = [];

function mapto2Darray() {
  for (let i = 0; i < mapHeight; i++) {
    map2DArray.push(tiledMapData.slice(i * mapWidth, (i + 1) * mapWidth));
  }
}

function showVaidPlacements() {
  for (let y = 0; y < map2DArray.length; y++) {
    for (let x = 0; x < map2DArray[y].length; x++) {
      if (map2DArray[y][x] === 2927) {
        ctx.fillStyle = "green";
        ctx.globalAlpha = 0.2;
        ctx.fillRect(x * 32, y * 32, 32, 32);
      } else if (map2DArray[y][x] === 1) {
        ctx.fillStyle = "red";
        ctx.globalAlpha = 0.2;
        ctx.fillRect(x * 32, y * 32, 32, 32);
      }
    }
  }
}

function canPlaceTower(x, y) {
  return map2DArray[y][x] === 2927;
}

function placeTower(x, y, type) {
  if (canPlaceTower(x, y)) {
    const towerData = towerTypes[type];
    if (!towerData) {
      console.error("Invalid tower type:", type);
      return;
    }

    if (playerCurrency >= towerData.cost) {
      let tower;
      if (type === "default") {
        tower = new Tower(x, y, 300, 8, 1000, 50, defaultTowerSpriteInfo, true);
      } else {
        tower = new towerData.class(x, y);
      }
      towers.push(tower);
      playerCurrency -= towerData.cost;
      map2DArray[y][x] = 0;

      if (activeWeatherBosses.size > 0) {
        const anyBoss = Array.from(activeWeatherBosses.values())[0].boss;
        anyBoss.applyWeatherEffectsToTower(tower);
      }
    } else {
      console.log("Not enough currency!");
    }
  } else {
    console.log("Tower placement occupied");
  }
}

let towerPreviewTimer = 0;
let towerPreviewAlpha = 0.5;
let towerPreviewIncreasing = false;

function getTowerRange(towerType) {
  const ranges = {
    default: 300,
    splash: 150,
    xray: 125,
    sniper: 400,
    freezing: 150,
    airdefence: 250,
  };
  return ranges[towerType] || 300;
}

function drawTowerPreview() {
  if (selectedTower || hoveredTile.x === -1 || hoveredTile.y === -1) return;

  if (canPlaceTower(hoveredTile.x, hoveredTile.y)) {
    const towerData = towerTypes[selectedTowerType];
    if (!towerData) return;

    towerPreviewTimer++;
    if (towerPreviewTimer % 10 === 0) {
      if (towerPreviewIncreasing) {
        towerPreviewAlpha += 0.1;
        if (towerPreviewAlpha >= 0.7) {
          towerPreviewIncreasing = false;
        }
      } else {
        towerPreviewAlpha -= 0.1;
        if (towerPreviewAlpha <= 0.3) {
          towerPreviewIncreasing = true;
        }
      }
    }

    ctx.beginPath();
    ctx.arc(
      hoveredTile.x * 32 + 16,
      hoveredTile.y * 32 + 16,
      getTowerRange(selectedTowerType),
      0,
      Math.PI * 2
    );
    ctx.fillStyle = `rgba(0, 0, 255, ${towerPreviewAlpha * 0.2})`;
    ctx.fill();
    ctx.strokeStyle = `rgba(0, 0, 255, ${towerPreviewAlpha})`;
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.save();

    ctx.globalAlpha = towerPreviewAlpha;

    if (selectedTowerType === "default") {
      const { sx, sy, sw, sh, dw, dh, frames, gap } = defaultTowerSpriteInfo;

      ctx.drawImage(
        defaultTowerSpriteSheet,
        sx,
        sy,
        sw,
        sh,
        hoveredTile.x * 32,
        hoveredTile.y * 32,
        dw,
        dh
      );
    } else if (selectedTowerType === "splash") {
      const { sx, sy, sw, sh, dw, dh, frames, gap } = splashTowerSpriteInfo;

      ctx.drawImage(
        splashTowerSpriteSheet,
        sx,
        sy,
        sw,
        sh,
        hoveredTile.x * 32,
        hoveredTile.y * 32,
        dw,
        dh
      );
    } else if (selectedTowerType === "freezing") {
      const { sx, sy, sw, sh, dw, dh, frames, gap } = iceTowerSpriteInfo;

      ctx.drawImage(
        iceTowerSpriteSheet,
        sx,
        sy,
        sw,
        sh,
        hoveredTile.x * 32,
        hoveredTile.y * 32,
        dw,
        dh
      );
    } else if (selectedTowerType === "sniper") {
      const { sx, sy, sw, sh, dw, dh, frames, gap } = sniperTowerSpriteInfo;

      ctx.drawImage(
        sniperTowerSpriteSheet,
        sx,
        sy,
        sw,
        sh,
        hoveredTile.x * 32,
        hoveredTile.y * 32,
        dw,
        dh
      );
    } else if (selectedTowerType === "xray") {
      const { sx, sy, sw, sh, dw, dh, frames, gap } = xrayTowerSpriteInfo;

      ctx.drawImage(
        XrayTowerSpriteSheet,
        sx,
        sy,
        sw,
        sh,
        hoveredTile.x * 32,
        hoveredTile.y * 32,
        dw,
        dh
      );
    } else if (selectedTowerType === "airdefence") {
      const { sx, sy, sw, sh, dw, dh, frames, gap } = airDefenseTowerSpriteInfo;

      ctx.drawImage(
        airDefenceTowerSpriteSheet,
        sx,
        sy,
        sw,
        sh,
        hoveredTile.x * 32,
        hoveredTile.y * 32,
        dw,
        dh
      );
    } else {
      ctx.fillStyle = getTowerPreviewColor(selectedTowerType);
      ctx.fillRect(hoveredTile.x * 32, hoveredTile.y * 32, 32 * 2, 32);
    }

    ctx.restore();
  }
}

function getTowerPreviewColor(towerType) {
  const colors = {
    splash: "yellow",
    xray: "purple",
    sniper: "Fuchsia",
    freezing: "lightblue",
    airdefence: "ForestGreen",
  };
  return colors[towerType] || "gray";
}
